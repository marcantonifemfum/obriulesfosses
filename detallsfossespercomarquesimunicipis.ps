%!
%% generem una llista comarcal de fosses en pdf (i html?) com a guia web pel registre telemàtic de petició d'exhumació
%% els municipis s'ordenen per ordre alfabètic i les fosses de cadascun també
%% podem detectar errors del dataset:
%%

%0% estructura d'1 fossa al dataset original passat a PS
%% <<
%%   (type) (Feature)
%%   (geometry) <<
%%                (type) (Point)
%%                (coordinates) [2.97553539276123 42.2641378583618]

%% ara ja podem treballar amb el visor VISSIR actualitzat de l'ICGC sense haver de convertir les coordenades geogràfiques a UTM31N-ETRS89, però encara sense xinxeta?
%% https://visors.icgc.cat/vissir/#loc=17/42.80578/0.95818

%%              >>
%%   (properties) <<
%%                  (:id) (row-9s8e_ew9i~gs9p)
%%                  (:version) (rv-pv8p.yu6z-dwu7)
%%                  (:created_at) (2025-02-17T10:51:08.031Z)
%%                  (:updated_at) (2025-02-18T09:02:37.369Z)
%%                  (id) (147)
%%                  (titol) (Cementiri de Figueres)
%%                  (categoria_de_fosses) (Confirmada)
%%                  (conservaci_) (Existent)
%%                  (tipologia_inhumats) (Civil, Soldat republicà)
%%                  (context_defunci_) (Repressió rereguarda)
%%                  (mida) (200)
%%                  (municipi) (Figueres)
%%                  (comarca) (Alt Empordà)
%%                  (prov_ncia) (Girona)
%%                  (comunitat_aut_noma) (Catalunya)
%%                  (pa_s) (Espanya)
%%                  (fitxa) <<
%%                            (url) (https://banc.memoria.gencat.cat/ca/results/mapa_fosses/147)
%%                          >>
%%                  (y) (42.2641378583618)
%%                  (x) (2.97553539276123)
%%                  (:@computed_region_bh64_c7uy) (191)
%%                  (:@computed_region_wvic_k925) (6)
%%                >>
%% >>

%% l'intèpret ens dóna una prefecta equivalència entre la notació decimal i UTF8, com es pot veure en aquest exemple:
%% GS>(Lluçanès) (Llu\303\247an\303\250s) eq ==
%% true

%%De moment no hem aconseguit crear objectes amb noms exclusivament numèrics dins d'un {#} i que pdfmark pugui treballar sense que es contaminin les variables
%% potser jugant amb les memòries locals vs globals ho aconseguiríem, però seria més costós que generar cadenes alfanumèriques
%% creació d'anotacions amb vincles externs a URL
%% l'array /Annots, per pàgina, la numerarem a partir de l' 1
/nAnnots 1 def  %% llavors equivaldrà a un comptador de pàgines
%% generem la cadena alfanumèrica
nAnnots 4 string cvs  %% ens servirà com a nom únic de l'objecte diccionari
({ARAannots_) dup length dup /ARAva exch def 2 index length add string dup 3 -1 roll 0 exch putinterval dup 3 -1 roll ARAva exch putinterval
(}) exch dup length dup /ARAva exch def 2 index length add string dup 3 -1 roll 0 exch putinterval dup 3 -1 roll ARAva exch putinterval
/ARAannots exch def  %% el nom alfanumèric únic NO contaminable

%% plantem l'array d'anotacions de PDF sofisticades a l'arrel /Page per tal siguin llegibles amb qualsevol dispositiu i viewer
mark /_objdef ARAannots cvx exec /type /array /OBJ pdfmark
mark {ThisPage} << /Annots ARAannots cvx exec >> /PUT pdfmark

%1 aAnnots add /aAnnots exch def
%{//aAnnots} ===
%ARRIBES?

/42cIDnom
<<  %% el codi alfabètic identificatiu de 2 lletres en caixa alta, oficial, i el nom de la comarca
/AE
(l'Alt Empord\303\240)
/LL
(el Llu\303\247an\303\250s)
/BD
(el Bergued\303\240)
/GX
(la Garrotxa)
/VN
(l'Aran)
/AU
(l'Alt Urgell)
/TR
(el Tarragon\303\250s)
/RI
(el Ripoll\303\250s)
/SL
(el Solson\303\250s)
/GN
(el Giron\303\250s)
/OS
(Osona)
/PE
(Pla de l'Estany)
/BC
(el Baix Camp)
/PR
(el Priorat)
/VR
(el Vall\303\250s Oriental)
/MO
(el Moian\303\250s)
/PU
(el Pla d'Urgell)
/GG
(les Garrigues)
/SR
(la Segarra)
/GF
(el Garraf)
/BP
(el Baix Pened\303\250s)
/TT
(la Terra Alta)
/AP
(l'Alt Pened\303\250s)
/BG
(el Bages)
/VC
(el Vall\303\250s Occidental)
/CB
(la Conca de Barber\303\240)
/BT
(el Baix Llobregat)
/AG
(l'Alta Ribagor\303\247a)
/SI
(el Segri\303\240)
/BB
(el Baix Ebre)
/AC
(l'Alt Camp)
/UR
(l'Urgell)
/RE
(la Ribera d'Ebre)
/MM
(el Maresme)
/AI
(l'Anoia)
/BM
(el Baix Empord\303\240)
/SV
(la Selva)
/PJ
(el Pallars Juss\303\240)
/NG
(la Noguera)
/MT
(el Montsi\303\240)
/PS
(el Pallars Sobir\303\240)
/BR
(el Barcelon\303\250s)
/CD
(la Cerdanya)
>> def

%%PER CERCAR EN EL DATASET ORIGINAL, DEGUT A QUE HI HA COMARQUES REPETIDES, ENS CAL FILTRAR PELS 2 CARÀCTERS NORMATIUS QUE DEFINEIXEN LES 42 COMARQUES CATALANES
(VN)  %% 2 caràcters indicatius de la comarca
/CERQUEM exch def

/diccionarisDeFossesD1comarca [] def  %% hi haurà el diccionari de la clau (properties) de cada fossa!

desoriComarcal
{  %% forall per l'indicatiu comarcal de 2 glifs que ens desa les fosses d'1 comarca
 CERQUEM eq
 {
  /nCERQUEM exch def
  arrayFosses
  {  %% forall
   (properties)get dup /dComarca exch def
   (comarca)get nCERQUEM eq
   {
    dComarca dup length dict copy  %% profilaxi
    diccionarisDeFossesD1comarca dup length dup /araVa exch def 1 add array dup 3 -1 roll 0 exch putinterval
    dup 3 -1 roll araVa exch put /diccionarisDeFossesD1comarca exch def
   }if
  }forall
 }
 {
  pop
 }ifelse
}forall  %% per l'indicatiu comarcal de 2 glifs que ens desa les fosses d'1 comarca


%% de l'array de diccionaris de fosses d'1 comarca, n'hauríem d'extraure els noms únics dels municipis per tal de poder-los ordenar alfabèticament
/municipisNOordenats <<>> def

diccionarisDeFossesD1comarca
{
 (municipi) get dup municipisNOordenats exch known
 {
  pop
 }
 {
  municipisNOordenats exch null put
 }ifelse
}forall

[  %% les posem desordenadament en format string en una array
 municipisNOordenats
 {
  pop 128 string cvs
 }forall
]  %% aquí no tenim el problema de la caixa alta doncs tots els municipis comencen per caixa alta

%% ordena alfabèticament l'array d'strings o numèrics
%%Hem descobert un bug en aquest famós algorisme que penja el loop sine die! 
%% (QuickSort.ps) (r) file cvx exec QSortArray
%% endreça una seqüència de cadenes o numèrica existent a l'stack de menys a més (operador ge) o de més a menys (operador le)
%% a comptar des de la base de l'stack (molt útil mentre no sobreixim el màxim d'elements d'una stack)
[ exch  %% per encabir-hi l'array ordenada de menys a més (ge)
aload pop  %% desmpaquetem l'array
{  %% loop mentre estiguin desordenats
 counttomark dup 0 eq
 {
 }
 {
  1 sub
 }ifelse
 /iCul exch def
 %% escombrat d'ordenació
 iCul
 {  %% repeat
  iCul index /araCul exch def
  iCul 1 sub index araCul ge  %% ordre d'endreça
  {
   iCul 1 sub /iCul exch def
  }
  {
   iCul -1 roll
   iCul 1 add 1 roll
  }ifelse
 }repeat
 %% mirem si estan per ordre de menys a més (ge)
 %% o de més a menys (le), començant pel cul de l'stack
 /Ordenats true def
 counttomark dup 0 eq
 {
 }
 {
  1 sub
 }ifelse
 /iCul exch def
 iCul
 {  %% repeat
  iCul index /araCul exch def
  iCul 1 sub index araCul ge  %% ordre d'endreça
  {
   iCul 1 sub /iCul exch def
  }
  {
   /Ordenats false def
   exit
  }ifelse
 }repeat
 Ordenats{exit}if
}loop

]  %% tanquem l'array ordenada de menys a més
/AmunicipisOrdenats exch def  %% array de municipis ordenats d'1 comarca

%% aquestes dades del dataset de municipis s'han de revisar cada vegada que s'actualitzen
%% extret de https://analisi.transparenciacatalunya.cat/Urbanisme-infraestructures/Municipis-Catalunya-Geo/9aju-tpwc/about_data 
(/var/www/html/www.obriulesfosses.cat/exhumeu/tramits/Municipis_Catalunya_Geo_20251020.geojsonps) (r) file cvx exec
/datasetMunicipis exch def

%% un cop ho tinguem fet, els cridarem a /diccionarisDeFossesD1comarca per agrupar les fosses per municipi
[  %% array de dicionaris de fosses per municipi amb les dades que necessitem pel registre a Justícia que quedaran en el mateix ordre que /AmunicipisOrdenats
 AmunicipisOrdenats
 {  %% forall per treure per ordre alfabètic de municipis les fosses de cadascun
  /araM exch def
  /dMunicipi <<>> def  %% diccionari amb les fosses d'1 municipi
  diccionarisDeFossesD1comarca
  {  %% forall pels diccionaris (properties) de cadacuna de les fosses de la comarca
   dup (municipi) get araM eq  %% ATENCIÓ: el camp municipi del dataset pot ser el nom d'un nucli de població o EMD i no pas el del municipi oficial al què pertany
   {

%%A través d'aquest nombre podem saber el nom oficial del municipi juntament amb el seu Codi identificador
dup (:@computed_region_bh64_c7uy) get /nMUNICIPI exch def

datasetMunicipis (features) get
{  %% forall per cercar a quin municipi correspon el camp numèric (:@computed_region_bh64_c7uy) del codi identificador oficial

 (properties) get dup (:@computed_region_bh64_c7uy) get nMUNICIPI eq
 {
  dup (nom) get /MUNICIPI exch def  %% nom oficial del municipi
  (codi) get /Ci exch def  %% codi identificador del municipi oficial
  exit
 }
 {
  pop
 }ifelse
}forall
%=== MUNICIPI == Ci == FFFFF

    /araDF exch def
    /dFossa <<>> def  %% diccionari amb les dades d'1 fossa
    %% claus amb dades de cadascuna de les fosses: _municipi _MUNICIPI _Ci _IDdataset _nom _exhumada _URLbanc _URLosm _URLicgc _LON _LAT _reclamada _IDtramit _URLtramits
    dFossa /_municipi araM put
    dFossa /_MUNICIPI MUNICIPI put
    dFossa /_Ci Ci put
    dFossa /_IDdataset araDF (id) get put
    dFossa /_nom araDF (titol) get put
    dFossa /_exhumada araDF (conservaci_) get (Excavada) eq  %% s'ha exhumat?
    {
     true put
    }
    {
     false put
    }ifelse
    dFossa /_URLbanc araDF (fitxa) get (url) get put
%% adreça Open Street Maps
%% https://www.openstreetmap.org/?mlat=41.971010731879886&mlon=0.8592643715470463#map=17/41.971010/0.859262
    dFossa /_URLosm
    (https://www.openstreetmap.org/?mlat=) dup length dup /araVa exch def araDF (y) get dup /ARAlat exch def
    dup null eq
    {
dFossa /_nom get ==
(sense LAT!)==
     pop (null) dup /ARAlat exch def
    }if
    dup length 3 -1 roll add string dup 4 -1 roll 0 exch putinterval dup
    3 -1 roll araVa exch putinterval dup length dup /araVa exch def (&mlon=) dup length 3 -1 roll add string dup 4 -1 roll 0 exch putinterval dup
    3 -1 roll araVa exch putinterval dup length dup /araVa exch def araDF (x) get dup /ARAlon exch def
    dup null eq
    {
dFossa /_nom get ==
(sense LON!)==
     pop (null) dup /ARAlon exch def
    }if
    dup length 3 -1 roll add string dup 4 -1 roll 0 exch putinterval dup
    3 -1 roll araVa exch putinterval dup length dup /araVa exch def (#map=17/) dup length 3 -1 roll add string dup 4 -1 roll 0 exch putinterval dup
    3 -1 roll araVa exch putinterval dup length dup /araVa exch def ARAlat dup length 3 -1 roll add string dup 4 -1 roll 0 exch putinterval dup
    3 -1 roll araVa exch putinterval dup length dup /araVa exch def (/) dup length 3 -1 roll add string dup 4 -1 roll 0 exch putinterval dup
    3 -1 roll araVa exch putinterval dup length dup /araVa exch def ARAlon dup length 3 -1 roll add string dup 4 -1 roll 0 exch putinterval dup
    %% cridem una capa que ens detalla el terme municipal N (no podem cridar una vista aèria), variables possibles: N, YN, CN, TN, PN (detall topogràfic), ON, HN
    3 -1 roll araVa exch putinterval dup length dup /araVa exch def (&layers=N) dup length 3 -1 roll add string dup 4 -1 roll 0 exch putinterval dup
    3 -1 roll araVa exch putinterval
    put

%% adreça al visor VISSIR de l'Institut Cartogràfic i Geològic de Catalunya
%% https://visors.icgc.cat/vissir/#loc=17/42.80578/0.95818
    dFossa /_URLicgc
    (https://visors.icgc.cat/vissir/#loc=17/) dup length dup /araVa exch def araDF (y) get dup /ARAlat exch def
    dup null eq
    {
dFossa /_nom get ==
(sense LAT!)==
     pop (null) dup /ARAlat exch def
    }if
    dup length 3 -1 roll add string dup 4 -1 roll 0 exch putinterval dup
    3 -1 roll araVa exch putinterval dup length dup /araVa exch def (/) dup length 3 -1 roll add string dup 4 -1 roll 0 exch putinterval dup
    3 -1 roll araVa exch putinterval dup length dup /araVa exch def araDF (x) get dup /ARAlon exch def
    dup null eq
    {
dFossa /_nom get ==
(sense LON!)==
     pop (null) dup /ARAlon exch def
    }if
    dup length 3 -1 roll add string dup 4 -1 roll 0 exch putinterval
    dup 3 -1 roll araVa exch putinterval
%% mentre no tinguem una altra variable per assenyalar amb una xinxeta no hi hem d'afegir res més
%    dup length dup /araVa exch def (#map=17/) dup length 3 -1 roll add string dup 4 -1 roll 0 exch putinterval dup
%    3 -1 roll araVa exch putinterval dup length dup /araVa exch def ARAlat dup length 3 -1 roll add string dup 4 -1 roll 0 exch putinterval dup
%    3 -1 roll araVa exch putinterval dup length dup /araVa exch def (/) dup length 3 -1 roll add string dup 4 -1 roll 0 exch putinterval dup
%    3 -1 roll araVa exch putinterval dup length dup /araVa exch def ARAlon dup length 3 -1 roll add string dup 4 -1 roll 0 exch putinterval dup
    %% cridem una capa que ens detalla el terme municipal N (no podem cridar una vista aèria), variables possibles: N, YN, CN, TN, PN (detall topogràfic), ON, HN
%    3 -1 roll araVa exch putinterval dup length dup /araVa exch def (&layers=N) dup length 3 -1 roll add string dup 4 -1 roll 0 exch putinterval dup
%    3 -1 roll araVa exch putinterval
    put

    %% desem per separat _LON _LAT
    dFossa /_LON ARAlon put
    dFossa /_LAT ARAlat put
    dFossa /_reclamada
    %GGtramits (<<>>) %% per saber si ha estat reclamada hauríem de fer una consulta a un diccionari que haguem bastit abans amb aquesta dada, via la seva ID al dataset
    <<>> araDF (id) get known
    {
     true put
     dFossa /_IDtramit <<>> araDF (id) get get (IDtrami) get put
     dFossa /_IDtramit <<>> araDF (id) get get (URLtramits) get put
    }
    {
     false put
     dFossa /_IDtramit (--) put
     dFossa /_URLtramits (fossa####_tramitsJusticiAjuntament.pdf) put
    }ifelse

    %% desem la fossa amb les dades que ens interessen pel registre amb la clau id del dataset
    dMunicipi araDF (id) get dFossa dup length dict copy put
   }
   {
    pop
   }ifelse
  }forall  %% pels diccionaris originals de cadacuna de les fosses de la comarca
  dMunicipi dup length dict copy  %% profilaxi pel munici enllestit abans no quedi a l'stack per l'array
 }forall  %% per treure per ordre alfabètic de municipis les fosses de cadascun
] /adddfpm exch def  %% array de dicionaris de fosses per municipi 

%%AQUÍ ÉS ON PODRÍEM GENERAR UN PDF/HTML, PER COMARQUES, AMB LES DADES DE LES FOSSES DE CADA MUNICIPI
(UbuntuMono-R.ttf)
%(Hack-Regular.ttf)  %% adreça relativa
findfont
%% codifiquem pels accents catalans i els possibles glifs alternatius de la F
dup length dict begin
{
 1 index /FID ne
 {def}{pop pop}ifelse
}forall
%% atenció que aquesta crida només és vàlida a Ghostscript!
/Encoding systemdict /EncodingDirectory get /WinAnsiEncoding get
%dup length array copy dup 0
%/Fhook put
%/Ghestrokecyrillic put
%/ghestrokecyrillic put
%/uni024D put
%/florin put
%/f put
%/uni0191 put
%/uni0493 put
%/uni0492 put
%/f_f put
def  %% xifrat WinAnsi
currentdict end /WApMono exch definefont pop
/WApMono findfont /araDfont exch def

(UbuntuMono-B.ttf)  %% adreça relativa
findfont
%% codifiquem pels accents catalans i els possibles glifs alternatius de la F
dup length dict begin
{
 1 index /FID ne
 {def}{pop pop}ifelse
}forall
%% atenció que aquesta crida només és vàlida a Ghostscript!
/Encoding systemdict /EncodingDirectory get /WinAnsiEncoding get
dup length array copy dup 0
%/Fhook put
%/Ghestrokecyrillic put
%/ghestrokecyrillic put
%/uni024D put
%/florin put
/f put
%/uni0191 put
%/uni0493 put
%/uni0492 put
%/f_f put
def  %% xifrat WinAnsi
currentdict end /dUbuntu_WApMono exch definefont pop
/dUbuntu_WApMono findfont
/UbuntuMonoB exch def


/ample 595 def
/alt 842 def
<</PageSize[ample alt]>>setpagedevice  %% A4
/margE 40 def

/maxX ample margE sub def
/arasomX margE def
alt margE 2 mul sub /arasomY exch def

42cIDnom CERQUEM known  %% el prefix comarcal existeix?
{
 42cIDnom CERQUEM get  %% comarca que explorem
 (decodificaWinAnsiEncoding_a1i2i3octets.ps) (r) file cvx exec AliniesD1solOctet 0 get
 dup ==
 araDfont 36 scalefont setfont
 arasomX arasomY moveto show

 arasomY 23 sub /arasomY exch def
 araDfont 18 scalefont setfont

 diccionarisDeFossesD1comarca length %% fosses totals de la comarca
 dup ==
 arasomX arasomY moveto
 4 string cvs show ( fosses comunes localitzades fins ara a la comarca)show

 adddfpm length  %% nombre de municipis amb fosses
 dup ==
 arasomX arasomY 18 sub dup /arasomY exch def moveto
 4 string cvs show ( municipis amb fosses comunes)show

 arasomX arasomY 18 sub dup /arasomY exch def moveto
 araDfont 14 scalefont setfont
 (Dataset publicat pel Departament de Justícia el dia )
 (decodificaWinAnsiEncoding_a1i2i3octets.ps) (r) file cvx exec AliniesD1solOctet 0 get
 show ddp show

 arasomY margE 2 mul sub /arasomY exch def

 /maxCIPI 0 def
 /maxF 0 def  %% desarem el nombre màxim llegit de fosses per municipi

 currentrgbcolor 3 array astore /araRGB exch def

 0 1 AmunicipisOrdenats length 1 sub
 {  %% for per cada municipi de la comarca

  dup AmunicipisOrdenats exch get  %% nom del municipi
  (decodificaWinAnsiEncoding_a1i2i3octets.ps) (r) file cvx exec AliniesD1solOctet 0 get

  dup /araCIPI exch def

  araDfont 24 scalefont setfont
  arasomX arasomY moveto

  currentpoint exch pop margE 2 mul le
  {
   currentrgbcolor 3 array astore /araRGB exch def
   showpage

%% generem la cadena alfanumèrica
nAnnots 1 add dup /nAnnots exch def
4 string cvs  %% ens servirà com a nom únic de l'objecte diccionari
({ARAannots_) dup length dup /ARAva exch def 2 index length add string dup 3 -1 roll 0 exch putinterval dup 3 -1 roll ARAva exch putinterval
(}) exch dup length dup /ARAva exch def 2 index length add string dup 3 -1 roll 0 exch putinterval dup 3 -1 roll ARAva exch putinterval
/ARAannots exch def  %% el nom alfanumèric únic NO contaminable

%% plantem l'array d'anotacions de PDF sofisticades a l'arrel /Page per tal siguin llegibles amb qualsevol dispositiu i viewer
mark /_objdef ARAannots cvx exec /type /array /OBJ pdfmark
mark {ThisPage} << /Annots ARAannots cvx exec >> /PUT pdfmark

   araRGB aload pop setrgbcolor
   alt margE sub /arasomY exch def
   arasomX arasomY moveto
  }if

  show

  araDfont 12 scalefont setfont

  adddfpm
%=== AAAAAAAAAAA
  exch get dup length  %% nombre de fosses del municipi

  dup maxF gt
  {
   araCIPI /maxCIPI exch def
   dup /maxF exch def
  }if

  arasomY 12 sub /arasomY exch def
  arasomX arasomY moveto
  4 string cvs show ( fosses comunes)show
  arasomY 24 sub /arasomY exch def

  currentpoint exch pop margE 2 mul le
  {
   currentrgbcolor 3 array astore /araRGB exch def
   showpage

%% generem la cadena alfanumèrica
nAnnots 1 add dup /nAnnots exch def
4 string cvs  %% ens servirà com a nom únic de l'objecte diccionari
({ARAannots_) dup length dup /ARAva exch def 2 index length add string dup 3 -1 roll 0 exch putinterval dup 3 -1 roll ARAva exch putinterval
(}) exch dup length dup /ARAva exch def 2 index length add string dup 3 -1 roll 0 exch putinterval dup 3 -1 roll ARAva exch putinterval
/ARAannots exch def  %% el nom alfanumèric únic NO contaminable

%% plantem l'array d'anotacions de PDF sofisticades a l'arrel /Page per tal siguin llegibles amb qualsevol dispositiu i viewer
mark /_objdef ARAannots cvx exec /type /array /OBJ pdfmark
mark {ThisPage} << /Annots ARAannots cvx exec >> /PUT pdfmark

   araRGB aload pop setrgbcolor
   alt margE sub /arasomY exch def
  }if

%% primer ordenarem per nom les fosses d'1 municipi i després ja extraurem les dades de cada fossa que interessen pel registre de petició
dup /dFossesD1municipi exch def
[ exch
 {  %% forall per extraure els noms de les fosses d'1 municipi dins una array sense ordre alfabètic
  /_nom get exch pop
 }forall
]  %% sembla que aquí tampoc no tenim problemes de caixa perquè tots els noms comencen en caixa alta
%%EP! en algun cas ens caldria passar-ho tot a caixa baixa per tal d'evitar l'error de quan la caixa alta té un equivalent numèric més petit? Avià abella

%% ordena alfabèticament l'array d'strings o numèrics
%%Hem descobert un bug en aquest famós algorisme que penja el loop sine die! 
%% (QuickSort.ps) (r) file cvx exec QSortArray
%% endreça una seqüència de cadenes o numèrica existent a l'stack de menys a més (operador ge) o de més a menys (operador le)
%% a comptar des de la base de l'stack (molt útil mentre no sobreixim el màxim d'elements d'una stack)
[ exch  %% per encabir-hi l'array ordenada de menys a més (ge)
aload pop  %% desmpaquetem l'array
{  %% loop mentre estiguin desordenats
 counttomark dup 0 eq
 {
 }
 {
  1 sub
 }ifelse
 /iCul exch def
 %% escombrat d'ordenació
 iCul
 {  %% repeat
  iCul index /araCul exch def
  iCul 1 sub index araCul ge  %% ordre d'endreça
  {
   iCul 1 sub /iCul exch def
  }
  {
   iCul -1 roll
   iCul 1 add 1 roll
  }ifelse
 }repeat
 %% mirem si estan per ordre de menys a més (ge)
 %% o de més a menys (le), començant pel cul de l'stack
 /Ordenats true def
 counttomark dup 0 eq
 {
 }
 {
  1 sub
 }ifelse
 /iCul exch def
 iCul
 {  %% repeat
  iCul index /araCul exch def
  iCul 1 sub index araCul ge  %% ordre d'endreça
  {
   iCul 1 sub /iCul exch def
  }
  {
   /Ordenats false def
   exit
  }ifelse
 }repeat
 Ordenats{exit}if
}loop

]  %% tanquem l'array ordenada de menys a més
%/fossesOrdenadesD1municipi exch def  %% array dels noms de fosses ordenades d'1 municipi

  {  %% forall dels noms ordenats de les fosses d'1 municipi
   /nFossa exch def
   dFossesD1municipi
   {
    dup /_nom get nFossa eq
    {  %% deixem només el diccionari de la fossa que ara toca a l'stack i sortim
     exch pop exit
    }
    {
     pop pop
    }ifelse
   }forall

   %% componem de cada fossa d'1 municipi les dades necessàries per la reclamació d'exhumació
%=== UUUUUU
   dup /FaF exch def
   /_exhumada get
   {
    0 1 0 setrgbcolor
currentrgbcolor 3 array astore /araRGB exch def
   }
   {
currentrgbcolor 3 array astore /araRGB exch def
    FaF /_reclamada get
    {
     1 0 0 setrgbcolor
     %% aquí cal muntar una nova URL amb la ID del tràmit per poder accedir als registres de reclamació i respostes
    }if
   }ifelse

   %pop  %% ens carreguem la clau amb la ID de la fossa

   gsave
   araDfont 12 scalefont setfont
   arasomX arasomY moveto
   (NOM:) show
   grestore

   gsave
   FaF /_nom get  %% nom de la fossa comuna
   (decodificaWinAnsiEncoding_a1i2i3octets.ps) (r) file cvx exec AliniesD1solOctet 0 get
   UbuntuMonoB 18 scalefont setfont
   arasomX margE add arasomY moveto

   %% un petit componedor amb l'operador search i un màxim de línia permesa, per tal de canviar de línia si es supera
   {  %% loop

    false
    {  %% mètode token és molt eficient però té almenys 2 pegues a l'interpretar les strings en clau de codi:
     token
     %% si troba p.e. 12345e54321 ho interpreta com un exponencial i dóna un error de /limitcheck
     %% si troba un ( sol sense tancar o obrir emet un /syntaxerror
     {
      128 string cvs dup stringwidth pop currentpoint pop add maxX ge
      {  %% canviem de línia!
       arasomX margE add arasomY 18 sub dup /arasomY exch def moveto
       show ( ) show  %% l'espai separador de paraules
      }
      {  %% seguim component dins la mateixa línia
       show ( ) show  %% l'espai separador de paraules
      }ifelse
     }
     {  %% sortim quan s'ha esgotat el text i llegeix la cadena buida de la cua
      exit
      %(\n\n >>> Hi ha hagut un error component el text amb l'operador token!\n\n)print flush
     }ifelse
    }
    {  %% mètode search
     ( ) search
     {
      dup stringwidth pop currentpoint pop add maxX ge
      {  %% canviem de línia!
       arasomX margE add arasomY 18 sub dup /arasomY exch def moveto
       show show  %% componem el mot separat i l'espai separador de paraules
      }
      {  %% seguim component dins la mateixa línia
       show show  %% componem el mot separat i l'espai separador de paraules
      }ifelse
     }
     {  %% sortim quan s'ha esgotat el text i deixa la darrera string per compondre
      dup stringwidth pop currentpoint pop add maxX ge
      {  %% canviem de línia!
       arasomX margE add arasomY 18 sub dup /arasomY exch def moveto
       show
      }
      {  %% seguim component dins la mateixa línia
       show
      }ifelse
      exit
     }ifelse
    }ifelse
   }loop

   grestore

   arasomY 18 sub /arasomY exch def

   araDfont 12 scalefont setfont
   arasomX arasomY moveto
   (ID:) show
   UbuntuMonoB 12 scalefont setfont
   arasomX margE 2 mul add arasomY moveto
   FaF /_IDdataset get  %% ID al dataset de la fossa comuna
   show
   arasomY 12 sub /arasomY exch def
   currentpoint exch pop margE 2 mul le
   {
    currentrgbcolor 3 array astore /araRGB exch def
    showpage

%% generem la cadena alfanumèrica
nAnnots 1 add dup /nAnnots exch def
4 string cvs  %% ens servirà com a nom únic de l'objecte diccionari
({ARAannots_) dup length dup /ARAva exch def 2 index length add string dup 3 -1 roll 0 exch putinterval dup 3 -1 roll ARAva exch putinterval
(}) exch dup length dup /ARAva exch def 2 index length add string dup 3 -1 roll 0 exch putinterval dup 3 -1 roll ARAva exch putinterval
/ARAannots exch def  %% el nom alfanumèric únic NO contaminable

%% plantem l'array d'anotacions de PDF sofisticades a l'arrel /Page per tal siguin llegibles amb qualsevol dispositiu i viewer
mark /_objdef ARAannots cvx exec /type /array /OBJ pdfmark
mark {ThisPage} << /Annots ARAannots cvx exec >> /PUT pdfmark

    araRGB aload pop setrgbcolor
    alt margE sub /arasomY exch def
   }if

   araDfont 12 scalefont setfont
   arasomX arasomY moveto
   (MUNICIPI:) show
   UbuntuMonoB 12 scalefont setfont
   arasomX margE 2 mul add arasomY moveto
   FaF /_MUNICIPI get  %% nom del municipi oficial de la fossa comuna
   (decodificaWinAnsiEncoding_a1i2i3octets.ps) (r) file cvx exec AliniesD1solOctet 0 get
   show ( | ) show
   FaF /_Ci get show  %% codi identificador del municipi
   arasomY 12 sub /arasomY exch def
   currentpoint exch pop margE 2 mul le
   {
    currentrgbcolor 3 array astore /araRGB exch def
    showpage

%% generem la cadena alfanumèrica
nAnnots 1 add dup /nAnnots exch def
4 string cvs  %% ens servirà com a nom únic de l'objecte diccionari
({ARAannots_) dup length dup /ARAva exch def 2 index length add string dup 3 -1 roll 0 exch putinterval dup 3 -1 roll ARAva exch putinterval
(}) exch dup length dup /ARAva exch def 2 index length add string dup 3 -1 roll 0 exch putinterval dup 3 -1 roll ARAva exch putinterval
/ARAannots exch def  %% el nom alfanumèric únic NO contaminable

%% plantem l'array d'anotacions de PDF sofisticades a l'arrel /Page per tal siguin llegibles amb qualsevol dispositiu i viewer
mark /_objdef ARAannots cvx exec /type /array /OBJ pdfmark
mark {ThisPage} << /Annots ARAannots cvx exec >> /PUT pdfmark

    araRGB aload pop setrgbcolor
    alt margE sub /arasomY exch def
   }if

   araDfont 12 scalefont setfont
   arasomX arasomY moveto
   (COORDENADES:) show
   UbuntuMonoB 12 scalefont setfont
   arasomX margE 2 mul add arasomY moveto
   FaF /_URLosm get  %% URL d'Open Street Maps
   /linkOSM exch def
   FaF /_URLicgc get  %% URL de l'Institut Cartogràfic i Geològic de Catalunya
   /linkICGC exch def
   FaF dup /_LON get show (,)show /_LAT get show

%(?) search pop pop pop  %% el deslliguem de l'adreça URL encara per concretar
%show

   arasomY 12 sub /arasomY exch def
   currentpoint gsave
   .5 .5 .5 setrgbcolor ( [OSM] )
   dup gsave true charpath pathbbox 4 array astore /elRectOSM exch def grestore
   show
   ([ICGC] ) dup gsave true charpath pathbbox 4 array astore /elRectICGC exch def grestore
   show
   grestore

%% comprovem que BBox és correcte?
%gsave 1 0 0 setrgbcolor elRect aload pop exch 3 index sub exch 2 index sub rectstroke grestore

%%LINK a OSM
   %% generem els objectes per vincular la geolocalització, xinxeta inclosa, al punt exacte on el dataset indica que es troba la fossa
   %% crear 1 objecte diccionari que s'inscriu a la data de publicació del darrer dataset i que s'afegirà a {clauAnnots}
   FaF /_IDdataset get  %% la ID al dataset de la fossa comuna ens servirà com a nom únic de l'objecte diccionari
   dup /idDataset exch def
   ({URLmapaOSM) dup length dup /ARAva exch def 2 index length add string dup 3 -1 roll 0 exch putinterval dup 3 -1 roll ARAva exch putinterval
   (}) exch dup length dup /ARAva exch def 2 index length add string dup 3 -1 roll 0 exch putinterval dup 3 -1 roll ARAva exch putinterval
   /ARAlinkOSM exch def  %% el nom únic

   %% actualitzem el valor
   %dvURL 1 add /dvURL exch def

   mark /_objdef
   ARAlinkOSM cvx exec
   /type /dict /OBJ pdfmark
   %% incrustar els valors de l'aparença gràfica de l'anotació de la comarca al diccionari
   mark
   ARAlinkOSM cvx exec
   <<
     /Rect elRectOSM  %% té format Bbox amb origen a LL
     /Subtype /Link
     /A <<
          /URI linkOSM
          /S /URI
        >>
      /Border [0 0 0]
      %/Border [16 16 1]
      %/Color [0 0 1]
      /Type /Annot
   >> /PUT pdfmark
   %% fiquem la referència indirecta de cada anotació dins l'array /Annots per pàgina
   mark ARAannots cvx exec ARAlinkOSM cvx exec /APPEND pdfmark

%%LINK a ICGC
   %% generem els objectes per vincular la geolocalització, xinxeta inclosa?, al punt exacte on el dataset indica que es troba la fossa
   %% crear 1 objecte diccionari que s'inscriu a la data de publicació del darrer dataset i que s'afegirà a {clauAnnots}
   FaF /_IDdataset get  %% la ID al dataset de la fossa comuna ens servirà com a nom únic de l'objecte diccionari
   dup /idDataset exch def
   ({URLmapaICGC) dup length dup /ARAva exch def 2 index length add string dup 3 -1 roll 0 exch putinterval dup 3 -1 roll ARAva exch putinterval
   (}) exch dup length dup /ARAva exch def 2 index length add string dup 3 -1 roll 0 exch putinterval dup 3 -1 roll ARAva exch putinterval
   /ARAlinkICGC exch def  %% el nom únic

   %% actualitzem el valor
   %dvURL 1 add /dvURL exch def

   mark /_objdef
   ARAlinkICGC cvx exec
   /type /dict /OBJ pdfmark
   %% incrustar els valors de l'aparença gràfica de l'anotació de la comarca al diccionari
   mark
   ARAlinkICGC cvx exec
   <<
     /Rect elRectICGC  %% té format Bbox amb origen a LL
     /Subtype /Link
     /A <<
          /URI linkICGC
          /S /URI
        >>
      /Border [0 0 0]
      %/Border [16 16 1]
      %/Color [0 0 1]
      /Type /Annot
   >> /PUT pdfmark
   %% fiquem la referència indirecta de cada anotació dins l'array /Annots per pàgina
   mark ARAannots cvx exec ARAlinkICGC cvx exec /APPEND pdfmark

%=== UEP!
   exch pop margE 2 mul le
   {
    currentrgbcolor 3 array astore /araRGB exch def
    showpage

%% generem la cadena alfanumèrica
nAnnots 1 add dup /nAnnots exch def
4 string cvs  %% ens servirà com a nom únic de l'objecte diccionari
({ARAannots_) dup length dup /ARAva exch def 2 index length add string dup 3 -1 roll 0 exch putinterval dup 3 -1 roll ARAva exch putinterval
(}) exch dup length dup /ARAva exch def 2 index length add string dup 3 -1 roll 0 exch putinterval dup 3 -1 roll ARAva exch putinterval
/ARAannots exch def  %% el nom alfanumèric únic NO contaminable

%% plantem l'array d'anotacions de PDF sofisticades a l'arrel /Page per tal siguin llegibles amb qualsevol dispositiu i viewer
mark /_objdef ARAannots cvx exec /type /array /OBJ pdfmark
mark {ThisPage} << /Annots ARAannots cvx exec >> /PUT pdfmark

    araRGB aload pop setrgbcolor
    alt margE sub /arasomY exch def
   }if

   araDfont 12 scalefont setfont
   arasomX arasomY moveto
   (DATASET:) show
   UbuntuMonoB 12 scalefont setfont
   arasomX margE 2 mul add arasomY moveto
   ddp show
   arasomY 12 sub /arasomY exch def
   currentpoint exch pop margE 2 mul le
   {
    currentrgbcolor 3 array astore /araRGB exch def
    showpage

%% generem la cadena alfanumèrica
nAnnots 1 add dup /nAnnots exch def
4 string cvs  %% ens servirà com a nom únic de l'objecte diccionari
({ARAannots_) dup length dup /ARAva exch def 2 index length add string dup 3 -1 roll 0 exch putinterval dup 3 -1 roll ARAva exch putinterval
(}) exch dup length dup /ARAva exch def 2 index length add string dup 3 -1 roll 0 exch putinterval dup 3 -1 roll ARAva exch putinterval
/ARAannots exch def  %% el nom alfanumèric únic NO contaminable

%% plantem l'array d'anotacions de PDF sofisticades a l'arrel /Page per tal siguin llegibles amb qualsevol dispositiu i viewer
mark /_objdef ARAannots cvx exec /type /array /OBJ pdfmark
mark {ThisPage} << /Annots ARAannots cvx exec >> /PUT pdfmark

    araRGB aload pop setrgbcolor
    alt margE sub /arasomY exch def
   }if

   araDfont 12 scalefont setfont
   arasomX arasomY moveto
   (URL FITXA:) show
   arasomX margE 2 mul add arasomY moveto
   FaF /_URLbanc get  %% coordenades geogràfiques de la fossa comuna (cal concretar l'ordre LON/LAT?)
   dup gsave true charpath pathbbox 4 array astore /elRect exch def grestore
   .5 .5 .5 setrgbcolor dup /linkBM exch def
   show
   araRGB aload pop setrgbcolor
   %% fem el vincle a la fitxa oficial del Banc de Memòria del departament de Justícia
   idDataset ({URLFitxaBancMem) dup length dup /ARAva exch def 2 index length add string dup 3 -1 roll 0 exch putinterval dup 3 -1 roll ARAva exch putinterval
   (}) exch dup length dup /ARAva exch def 2 index length add string dup 3 -1 roll 0 exch putinterval dup 3 -1 roll ARAva exch putinterval
   /ARAlinkURL exch def  %% el nom únic

   %% actualitzem el valor
   %dvURL 1 add /dvURL exch def

   mark /_objdef
   ARAlinkURL cvx exec
   /type /dict /OBJ pdfmark
   %% incrustar els valors de l'aparença gràfica de l'anotació de la comarca al diccionari
   mark
   ARAlinkURL cvx exec
   <<
     /Rect elRect  %% té format Bbox amb origen a LL
     /Subtype /Link
     /A <<
          /URI linkBM
          /S /URI
        >>
      /Border [0 0 0]
      %/Border [16 16 1]
      %/Color [0 0 1]
      /Type /Annot
   >> /PUT pdfmark
   %% fiquem la referència indirecta de cada anotació dins l'array /Annots per pàgina
   mark ARAannots cvx exec ARAlinkURL cvx exec /APPEND pdfmark

   arasomY 12 sub /arasomY exch def
   currentpoint exch pop margE 2 mul le
   {
    currentrgbcolor 3 array astore /araRGB exch def
    showpage

%% generem la cadena alfanumèrica
nAnnots 1 add dup /nAnnots exch def
4 string cvs  %% ens servirà com a nom únic de l'objecte diccionari
({ARAannots_) dup length dup /ARAva exch def 2 index length add string dup 3 -1 roll 0 exch putinterval dup 3 -1 roll ARAva exch putinterval
(}) exch dup length dup /ARAva exch def 2 index length add string dup 3 -1 roll 0 exch putinterval dup 3 -1 roll ARAva exch putinterval
/ARAannots exch def  %% el nom alfanumèric únic NO contaminable

%% plantem l'array d'anotacions de PDF sofisticades a l'arrel /Page per tal siguin llegibles amb qualsevol dispositiu i viewer
mark /_objdef ARAannots cvx exec /type /array /OBJ pdfmark
mark {ThisPage} << /Annots ARAannots cvx exec >> /PUT pdfmark

araRGB aload pop setrgbcolor
    alt margE sub /arasomY exch def
   }if

araRGB aload pop setrgbcolor
   araDfont 12 scalefont setfont
   arasomX arasomY moveto
   (URL TRÀMITS:)
   (decodificaWinAnsiEncoding_a1i2i3octets.ps) (r) file cvx exec AliniesD1solOctet 0 get
   show
   arasomX margE 2 mul add arasomY moveto
   FaF /_URLtramits get  %% vincle al PDF amb tots els tràmits de la fossa a Justícia i a l'ajuntament
   dup idDataset dup length 9 exch sub exch putinterval  %% farcim la ID de la fossa al nom del PDF
   show
   arasomY 12 sub /arasomY exch def
   currentpoint exch pop margE 2 mul le
   {
    currentrgbcolor 3 array astore /araRGB exch def
    showpage

%% generem la cadena alfanumèrica
nAnnots 1 add dup /nAnnots exch def
4 string cvs  %% ens servirà com a nom únic de l'objecte diccionari
({ARAannots_) dup length dup /ARAva exch def 2 index length add string dup 3 -1 roll 0 exch putinterval dup 3 -1 roll ARAva exch putinterval
(}) exch dup length dup /ARAva exch def 2 index length add string dup 3 -1 roll 0 exch putinterval dup 3 -1 roll ARAva exch putinterval
/ARAannots exch def  %% el nom alfanumèric únic NO contaminable

%% plantem l'array d'anotacions de PDF sofisticades a l'arrel /Page per tal siguin llegibles amb qualsevol dispositiu i viewer
mark /_objdef ARAannots cvx exec /type /array /OBJ pdfmark
mark {ThisPage} << /Annots ARAannots cvx exec >> /PUT pdfmark

    araRGB aload pop setrgbcolor
    alt margE sub /arasomY exch def
   }if

%%EP! no va el detector de continuïtat del color quan p.e. es trenca una fossa en verd exhumada
   0 0 0 setrgbcolor

   arasomY 18 sub /arasomY exch def

  }forall  %% dels noms ordenats de les fosses d'1 municipi 

  arasomY 24 sub /arasomY exch def
 }for  %% for per cada municipi de la comarca

   0 0 0 setrgbcolor
 %%Avaluem
 maxCIPI ==
 maxF ==

%%COM fer notar els casos del trasllat a Cuelgamuros o les que consten com a desaparegudes??

 showpage  %% darrer showpage que hauria de ser condicional per si queda res a la cua?

}
{  %% el prefix comarcal no existeix
 (\n\n >>> el prefix comarcal... ) print flush CERQUEM print flush ( ...NO existeix!\n\n)print flush
}ifelse

(BROSSA?)pstack

%%Comportament de l'operador token en una string entre els codis decimats 0 i 255, tenint en compte que interpreta les combinatòries UTF8!
%% separa grups caràcters seguits en base als codis decimals 0 (\000), 9 (\011), 10 (\012), 12 (\014), 13 (\015), 32 (\040)
%% separa grups caràcters seguits i afegeix un espai (tabulador?) al caràcter següent en base als codi decimal 11 (\013)
%% esborra 1 caràcter que precedeixi el codi decimal 8 (\010) i també a ell mateix
%% ignora els caràcter dels decimals 1 (\001), 2 (\002), 3 (\003), 4 (\004), 5 (\005), 6 (\006), 7 (\007)
%% 14 (\016), 15 (\017), 16 (\020), 17 (\021), 18 (\022), 19 (\023), 20 (\024), 21 (\025), 22 (\026), 23 (\027)
%% 25 (\031)
%% 28 (\034), 29 (\035). 30 (\036), 31 (\037)
%% el decimals 24 (\030), 26 (\032) es transformen en la seqüencia UTF8… \342\226\222 …sense separar res
%% esborra 1 caràcter que segueixi al codi decimal 27 (\033) i també a ell mateix
%% ATENCIÓ: una estring tipus (54321E12345) provoca un limitcheck perquè s'interpreta com un nombre real amb la E o e d'exponencial que excedeix la grandària permesa
%% per explorar de l'1 al 255 tenim a token_analisi.ps

%% també, per tal de muntar la URL al punt cartogràfic, els camps (x) (y) o a l'array de (coordinates)
%% també a (fitxa) treure'n la (url) a la fitxa del Banc de Memòria

%% descripció de les variables amb dades clau i a quin .ps es creen:

   %% es creen a exhumaDataset_prototip0#.ps (que és cridat per faComarques_faHTMLobriulesfosses_prototip0#.ps)
%% /arrayFosses és una array de diccionaris (un per fossa) del dataset original segons el format de %0%
%% /desoriComarcal és un diccionari estàtic construït en base a l'estructura comarcal dels datasets: té de clau el nom de la comarca i de valor les dues lletres d'ID
%% /datasetComarques és un diccionari dinàmic que clona l'estructura comarcal del dataset: té de clau el nom de la comarca i de valor una array [#totalfosses #exhumades]
%% pot detectar si hi han hagut canvis en els noms o el nombre de comarques (però si el datatset n'ha omès no ho detecta)
%% /2glifsAfosses és un diccionari dinàmic que, com a valor, fusiona les dades [#totalfosses #exhumades] de les 3 comarques repetides i té de clau les dues lletres d'ID

   %% es creen a faComarques_faHTMLobriulesfosses_prototip0#.ps
%% /comarquesVSfosses és un diccionari estàtic que té de clau les dues lletres d'ID de cada comarca i com a valor un diccionari
%% que s'alimenta de les dades de /2glifsAfosses traslladant-hi el nombre de fosses totals i les exhumades i+

%%FILTRATS QUE HEM DE FER CADA VEGADA QUE S'ACTUALITZA EL DATASET:
%A% Les comarques repetides tenen dades complementàries o no?

%B% Hi han hagut canvis en el format comarcal?
   %1% Això passaria si al diccionari /desoriComarcal no s'hi trobés un nom de comarca que ve del dataset
   %2% O si el nombre de comarques que ve del dataset difereix del nombre de /desoriComarcal
   %3% Si es compleix %1% i %2% no, és que hi ha hagut un canvi de nom
   %4% Si es compleix %1% i %2%, és que hi ha hagut un nou afegit de nom de comarca (ara n'hi ha 3 de repetides!)
   %5% Si no es compleix %1% i %2% sí, és que el dataset ha omès alguna comarca!

%C% Hi han hagut canvis en el format de fosses?
   %1% nombre de camps
   %2% denominació dels camps

%D% Hi han hagut canvis en els continguts de fosses?
   %1% contingut dels camps

%E% Hi han hagut canvis en el nombre de fosses?
   %1% quines s'hi han afegit en relació al dataset anterior?
   %2% quines se n'han tret en relació al dataset anterior?

%%PASSEM A L'ACCIÓ


